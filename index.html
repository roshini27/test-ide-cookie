<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cookie Sync Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #357ae8;
        }
        .log-container {
            margin-top: 30px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        .log-entry {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-left: 4px solid #4285f4;
            font-family: monospace;
            font-size: 13px;
        }
        .log-entry.success {
            border-left-color: #34a853;
        }
        .log-entry.info {
            border-left-color: #fbbc04;
        }
        .iframe-container {
            display: none;
        }
        .cookie-display {
            background: #e8f0fe;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
        }
        .instructions {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .instructions h3 {
            margin-top: 0;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cookie Sync Demo</h1>
        <p class="subtitle">DoubleClick & Meta Cookie Synchronization</p>
        
        <div class="instructions">
            <h3>üìã Instructions:</h3>
            <ol>
                <li>Enter your DoubleClick NID and Meta Pixel ID below</li>
                <li>Open your browser's <strong>Developer Tools</strong> (F12)</li>
                <li>Go to the <strong>Network</strong> tab</li>
                <li>Click "Initiate Cookie Sync" button</li>
                <li>Look for requests to <code>doubleclick.net</code> and <code>facebook.com</code></li>
                <li>Check the <strong>Response Headers</strong> for 302 redirects and IDE parameter</li>
            </ol>
        </div>

        <div style="background: #e3f2fd; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">DoubleClick NID:</label>
                <input type="text" id="dcNid" placeholder="Enter your DoubleClick Network ID" 
                       style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
            <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Meta Pixel ID:</label>
                <input type="text" id="metaPixelId" placeholder="Enter your Meta Pixel ID" 
                       style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
        </div>

        <button onclick="initiateCookieSync()">Initiate Cookie Sync</button>
        <button onclick="checkCookies()">Check Cookies</button>
        <button onclick="clearLog()">Clear Log</button>

        <div class="cookie-display" id="cookieDisplay">
            Current Cookies: <span id="cookieInfo">Click "Check Cookies" to view</span>
        </div>

        <div class="log-container">
            <h3>Activity Log:</h3>
            <div id="logOutput"></div>
        </div>

        <!-- Hidden iframes for cookie sync -->
        <div class="iframe-container">
            <iframe id="dcFrame" style="display:none;"></iframe>
            <iframe id="fbFrame" style="display:none;"></iframe>
        </div>
    </div>

    <script>
        let logCount = 0;

        function log(message, type = 'info') {
            logCount++;
            const logOutput = document.getElementById('logOutput');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logOutput.appendChild(entry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logOutput').innerHTML = '';
            logCount = 0;
            log('Log cleared', 'info');
        }

        function generateUserId() {
            return 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }

        function initiateCookieSync() {
            const dcNid = document.getElementById('dcNid').value.trim();
            const metaPixelId = document.getElementById('metaPixelId').value.trim();

            if (!dcNid) {
                alert('Please enter your DoubleClick NID');
                log('‚ùå DoubleClick NID is required', 'info');
                return;
            }

            if (!metaPixelId) {
                alert('Please enter your Meta Pixel ID');
                log('‚ùå Meta Pixel ID is required', 'info');
                return;
            }

            log('üöÄ Initiating cookie sync process...', 'info');
            log(`Using DoubleClick NID: ${dcNid}`, 'success');
            log(`Using Meta Pixel ID: ${metaPixelId}`, 'success');
            
            const userId = generateUserId();
            log(`Generated User ID: ${userId}`, 'success');

            // Step 1: DoubleClick Cookie Sync
            // This will create an IDE (ID Exchange) cookie
            const dcSyncUrl = `https://cm.g.doubleclick.net/pixel?google_nid=${dcNid}&google_cm&gdpr=0&gdpr_consent=&google_sc=${userId}`;
            
            log('üì° Calling DoubleClick pixel for IDE creation...', 'info');
            log(`URL: ${dcSyncUrl}`, 'info');
            
            const dcFrame = document.getElementById('dcFrame');
            dcFrame.src = dcSyncUrl;
            
            dcFrame.onload = function() {
                log('‚úÖ DoubleClick pixel loaded - IDE cookie should be set', 'success');
                log('üí° Check Network tab for 302 redirect from doubleclick.net', 'info');
                log('üí° Look for "ide" parameter in the redirect URL', 'info');
                
                // Step 2: Meta/Facebook Cookie Sync
                setTimeout(() => {
                    syncWithMeta(userId, metaPixelId);
                }, 1000);
            };

            dcFrame.onerror = function() {
                log('‚ö†Ô∏è Error loading DoubleClick pixel (expected due to CORS)', 'info');
                // Continue with Meta sync anyway
                setTimeout(() => {
                    syncWithMeta(userId, metaPixelId);
                }, 1000);
            };
        }

        function syncWithMeta(userId, metaPixelId) {
            log('üì° Syncing with Meta/Facebook...', 'info');
            
            // Meta pixel with custom event
            const metaSyncUrl = `https://www.facebook.com/tr?id=${metaPixelId}&ev=CookieSync&cd[external_id]=${userId}&noscript=1`;
            
            log(`Meta URL: ${metaSyncUrl}`, 'info');
            
            const fbFrame = document.getElementById('fbFrame');
            fbFrame.src = metaSyncUrl;
            
            fbFrame.onload = function() {
                log('‚úÖ Meta pixel loaded successfully', 'success');
                log('üéâ Cookie sync process completed!', 'success');
                log('', 'info');
                log('üîç To verify in Network tab:', 'info');
                log('1. Find the request to cm.g.doubleclick.net/pixel', 'info');
                log('2. Check Status Code: should be 302 (redirect)', 'info');
                log('3. Check Response Headers ‚Üí Location header', 'info');
                log('4. Look for "ide=" parameter in the Location URL', 'info');
                log('5. Find the request to facebook.com/tr', 'info');
                log('6. Click "Check Cookies" to see stored cookies', 'info');
            };

            fbFrame.onerror = function() {
                log('‚ö†Ô∏è Error loading Meta pixel (expected due to CORS)', 'info');
                log('‚úÖ Cookie sync requests sent - check Network tab', 'success');
            };
        }

        function checkCookies() {
            const cookies = document.cookie;
            const cookieInfo = document.getElementById('cookieInfo');
            
            if (cookies) {
                cookieInfo.textContent = cookies;
                log('üìã Current cookies displayed above', 'success');
                
                // Check for specific cookies
                if (cookies.includes('IDE') || cookies.includes('ide')) {
                    log('‚úÖ Found IDE cookie from DoubleClick!', 'success');
                } else {
                    log('‚ÑπÔ∏è IDE cookie not visible (may be httpOnly or third-party)', 'info');
                }
            } else {
                cookieInfo.textContent = 'No cookies available (or all are httpOnly/secure)';
                log('‚ÑπÔ∏è No accessible cookies found', 'info');
                log('üí° Third-party cookies may be blocked by browser settings', 'info');
            }
        }

        // Initial log
        log('Cookie Sync Demo loaded. Click "Initiate Cookie Sync" to begin.', 'success');
        log('‚ö†Ô∏è Note: Third-party cookies may be blocked by your browser', 'info');
    </script>
</body>
</html>
