<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Analytics Production Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- ✅ OneTrust -->
  <script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"
    data-domain-script="0195138c-cdc8-738c-907d-131dad8db9ba-test"></script>
  <script>function OptanonWrapper(){}</script>

  <!-- ✅ Crypto -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>

  <!-- ✅ DataLayer -->
  <script>
    window.dataLayer = [{
      pageName: "Homepage",
      pageEnvironment: "test",
      customerId: "customerId123"
    }];
  </script>

  <!-- ✅ Analytics (ONLY ONCE) -->
  <script
    src="https://web-analytics-js2-dot-uxlwqzc-cdip-sandbox-test.uc.r.appspot.com/static/analytics.js
    ?crossdomainflag=true
    &deleteprofile=true
    &multiDomainFlag=true
    &googleCookieSyncFlag=true
    &automaticTracking=true
    &domainArray=[%22example.com%22,%22vercel.app%22]
    &requiredPurposeIds=[%221%22,%223%22,%224%22]
    &dataLayer=dataLayer">
  </script>

</head>
<body>

<h1>✅ Production Analytics + Google Cookie Sync</h1>
<button id="syncBtn">Trigger Google Cookie Sync</button>

<!-- ✅ Production Google Cookie Sync Class -->
<script>
(function () {

  if (window.GoogleCookieSync) return;

  class GoogleCookieSync {
    constructor(bidderNid, secretKey) {
      this.bidderNid = bidderNid;
      this.secretKey = secretKey;
      this.endpoint = "https://web-analytics-dot-uxlwqzc-cdip-sandbox-test.uc.r.appspot.com/sendevent";
    }

    firePixel() {
      return new Promise((resolve) => {
        const url = `https://cm.g.doubleclick.net/pixel?google_nid=${this.bidderNid}&google_cm=1&cb=${Date.now()}`;
        const img = new Image();

        let finished = false;

        const timeout = setTimeout(() => {
          if (!finished) {
            finished = true;
            resolve(true);
          }
        }, 3000);

        img.onload = () => {
          if (!finished) {
            finished = true;
            clearTimeout(timeout);
            resolve(true);
          }
        };

        img.onerror = () => {
          if (!finished) {
            finished = true;
            clearTimeout(timeout);
            resolve(false);
          }
        };

        img.src = url;
      });
    }

    async sync(userId) {
      const encryptedFlag = sessionStorage.getItem("google_cookie_sync_done");

      if (encryptedFlag) {
        const decrypted = CryptoJS.AES.decrypt(encryptedFlag, this.secretKey)
          .toString(CryptoJS.enc.Utf8);

        if (decrypted === "true") {
          console.log("[Google Sync] Already completed");
          return { alreadySynced: true };
        }
      }

      const pixelResult = await this.firePixel();

      const payload = {
        eventName: "googleCookieSync",
        userId,
        googlePixelFired: pixelResult,
        syncSuccessful: pixelResult,
        timestamp: new Date().toISOString(),
        networkId: this.bidderNid
      };

      await fetch(this.endpoint, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": "12345abc"
        },
        body: JSON.stringify(payload)
      });

      const encrypted = CryptoJS.AES.encrypt("true", this.secretKey).toString();
      sessionStorage.setItem("google_cookie_sync_done", encrypted);

      return { success: true };
    }
  }

  window.GoogleCookieSync = GoogleCookieSync;

})();
</script>

<script>
  const secretKey = "RW5jcnlwdGlvbktleQ==";
  const userId = "test-user-123";

  document.getElementById("syncBtn").onclick = async () => {
    const gcs = new GoogleCookieSync("1686285891", secretKey);
    const result = await gcs.sync(userId);
    console.log("Google Sync Result:", result);
  };
</script>

</body>
</html>
